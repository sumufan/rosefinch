---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xiaoyueya.
--- DateTime: 2018/12/22 下午10:27
---

local table_helper = require("helper.table_helper");
local authority_service = require("service.authority_service");
local common_error = require("api.api_common_error");
local cjson = require("cjson");


ngx.header.content_type = "text/plain";

--[[
    权限判断 app-api
]]
local request_args_tab = ngx.req.get_uri_args();
--1、参数为空 直接返回没有权限
if table_helper.empty_table(request_args_tab) then
    ngx.print(cjson.encode(common_error.token_error));
    return;
end

--2、判断参数中是否包含app_token
local app_token = request_args_tab["app_token"];
if app_token == nil or app_token == "" then
    ngx.print(cjson.encode(common_error.token_error));
    return;
end

--3、进行mas校验返回用户权限；
local uri = ngx.var.uri;
local result,err = authority_service.verify_user_authority(uri,app_token);
if err ~= nil then
    ngx.print(cjson.encode(common_error.token_error));
    return;
end

--权限访问
if result ~= true then
    ngx.print(cjson.encode(common_error.auth_error));
    return;
end


--4、打印压测数据；
ngx.print("this is bench page");
